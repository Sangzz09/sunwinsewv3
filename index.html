<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sunwin</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    // H√†m chuy·ªÉn h∆∞·ªõng nhanh
    function redirectToIndex() {
        // S·ª≠ d·ª•ng replace ƒë·ªÉ ngƒÉn ng∆∞·ªùi d√πng quay l·∫°i trang tool b·∫±ng n√∫t Back
        window.location.replace('index.html');
    }

    // Ch·∫°y h√†m hi·ªán n·ªôi dung ngay l·∫≠p t·ª©c
    document.addEventListener('DOMContentLoaded', () => {
        document.body.style.display = 'block'; // Hi·ªán body ngay sau khi DOM ƒë∆∞·ª£c t·∫£i
    });
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Share Tech Mono',monospace;
      background:radial-gradient(circle at 10% 10%, rgba(0,0,0,0.6), rgba(0,0,0,1));
      color:#00ff00;height:100vh;overflow:hidden;
      display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, s·∫Ω ƒë∆∞·ª£c JS hi·ªán l√™n ngay */
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    /* --- Overlays (Game Selection) --- */
    .overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0052D4, #4364F7, #6FB1FC);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      transition: opacity 0.3s ease;
    }

    /* iframe behind UI */
    #fullscreenIframe{position:fixed;inset:0;width:100%;height:100%;height:100dvh;border:0;z-index:1;}

    /* Main content hidden until login */
    .panel, #predictionPopup, .footer-text { display: none; }
    .panel.unlocked { display: flex; }
    .footer-text.unlocked { display: flex; }

    /* Left panel */
    .panel{
      position:fixed;left:12px;top:12px;z-index:99999;
      display:flex;flex-direction:column;gap:8px;width:180px;
    }
    .btn{
      background:rgba(0,255,0,0.09);
      color:#00ff00;border:1px solid rgba(0,255,0,0.25);
      padding:6px 8px; /* Gi·∫£m padding ƒë·ªÉ n√∫t nh·ªè l·∫°i */
      border-radius:8px;font-size:13px;text-align:center;
      cursor:pointer;transition:0.12s;
      font-weight: 950; /* TƒÉng ƒë·ªô ƒë·∫≠m 5% cho n√∫t */
    }
    .btn:hover{transform:translateY(-2px)}
    .btn:disabled{cursor:not-allowed;opacity:0.6;transform:none;}
    /* Hi·ªáu ·ª©ng n√∫t k√≠ch ho·∫°t n·ªïi b·∫≠t */
    #activateBtn {
      background: rgba(0, 255, 0, 0.2);
      border-color: #00ff00;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }
    .logout-btn{
      background:linear-gradient(90deg,#2b0000,#700000);color:#fff;border:1px solid #ff3b3b;
    }

    /* === Khung nh√°y v√† hi·ªáu ·ª©ng M·ªöI c·ªßa b·∫°n === */
    .prediction-box {
      position: fixed;
      bottom: 60px; 
      left: 50%;
      transform: translateX(-50%);
      /* ƒê∆∞a v·ªÅ gradient v√†ng/cam thu·∫ßn t√∫y */
      background: linear-gradient(to bottom, #ffd34d, #ffb800);
      border-radius: 12px;
      border: 1px solid #fff;
      padding: 4px 10px;
      display: none;
      align-items: flex-end;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 99999;
      cursor: move;
      touch-action: none;
    }
    
    .prediction-box .item {
        display:flex;
        flex-direction:column;
        align-items:center;
    }
    
    .prediction-box .label {
        font-weight:950;
        font-size:12px; 
        margin-bottom:2px;
        color:#000;
    }
    
    .prediction-box .circle {
        width:28px;
        height:28px;
        border-radius:50%; 
        border:2px solid #fff; 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        font-weight:bold; 
        font-size:12px; 
        opacity:0.2;
        transition: opacity 0.3s, box-shadow 0.3s, background 0.3s;
    }
    
    /* M√†u nh√°y m·ªõi cho T√ÄI (Gi·ªØ nguy√™n Xanh L√°) */
    .circle.active.tai {
      background: #00ff00;
      opacity:1; 
      box-shadow:0 0 10px #00ff00, 0 0 20px #00ff00;
    }

    /* M√†u nh√°y m·ªõi cho X·ªàU (M√†u ƒê·ªè) */
    .circle.active.xiu {
      background: #ff0000;
      opacity:1; 
      box-shadow:0 0 10px #ff0000, 0 0 20px #ff0000;
    }
    
    .prediction-box .logo {
        width:32px;
        height:auto;
        margin-bottom: 0px;
    }
    
    .prediction-box .close-btn {
        position:absolute;
        top:-6px;
        right:-6px;
        cursor:pointer;
        font-size:14px;
        font-weight:bold;
        color:#000;
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* CSS C·∫≠p nh·∫≠t cho th√¥ng tin Phi√™n/D·ª± ƒëo√°n/ƒê·ªô tin c·∫≠y */
    .footer-text{
        position:fixed;
        bottom:8px;
        right:12px; /* CƒÉn ph·∫£i */
        font-size:13px;
        color:#00ff00;
        text-shadow:0 0 5px #00ff00,0 0 10px #00ff00;
        z-index:50;
        display:flex; /* Hi·ªÉn th·ªã ngang h√†ng */
        align-items: center; 
        justify-content: flex-end;
        line-height: 1.4;
        padding: 5px 8px; 
        background: rgba(0, 0, 0, 0.3); 
        border-radius: 5px;
        white-space: nowrap; /* ƒê·∫£m b·∫£o kh√¥ng xu·ªëng d√≤ng */
        font-weight: 950; /* TƒÉng ƒë·ªô ƒë·∫≠m 5% cho footer text */
    }

    /* Keyframe ƒê√É S·ª¨A ƒë·ªÉ nh·∫•p nh√°y m∆∞·ª£t m√† h∆°n (d√πng ease-in-out thay v√¨ step-end) */
    @keyframes textBlinkSmooth {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* √Åp d·ª•ng hi·ªáu ·ª©ng nh·∫•p nh√°y ch·ªØ m∆∞·ª£t m√† */
    .blinking-text {
      animation: textBlinkSmooth 1s ease-in-out infinite; /* Thay step-end b·∫±ng ease-in-out */
    }

    @media(max-width:480px){
      #predictionPopup{ width:140px; height: 70px; right:8px; top:60px; left: auto; bottom: auto; transform: none;} 
      .prediction-box { gap: 6px; padding: 3px 8px; bottom: 50px; }
      .prediction-box .circle { width: 25px; height: 25px; font-size: 10px; border: 1.5px solid #fff; } 
      .prediction-box .logo { width: 28px; } 
      .prediction-box .label { font-size: 10px; margin-bottom: 1px; }
      /* Mobile UI Tweaks */
      .panel { width: 130px; left: 10px; top: 80px; gap: 8px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 12px; border: 1px solid rgba(0,255,0,0.5); backdrop-filter: blur(5px); }
      .btn { font-size: 10px; padding: 4px 8px; }
      .footer-text { font-size: 10px; right: 5px; bottom: 5px; max-width: 90%; white-space: normal; text-align: right; }
    }

    /* === LOGIN SCREEN === */
    #loginScreen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, #0a0a0a, #000);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .login-box {
      background: rgba(0,255,0,0.04);
      border: 1px solid rgba(0,255,0,0.3);
      border-radius: 16px;
      padding: 36px 30px;
      width: 320px;
      max-width: 90vw;
      text-align: center;
      box-shadow: 0 0 30px rgba(0,255,0,0.1);
    }
    .login-logo {
      width: 70px;
      margin-bottom: 14px;
    }
    .login-title {
      font-size: 20px;
      color: #00ff00;
      text-shadow: 0 0 8px #00ff00;
      margin-bottom: 6px;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .login-subtitle {
      font-size: 11px;
      color: rgba(0,255,0,0.5);
      margin-bottom: 24px;
      letter-spacing: 1px;
    }
    .key-input-wrap {
      position: relative;
      margin-bottom: 16px;
    }
    #keyInput {
      width: 100%;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(0,255,0,0.35);
      border-radius: 8px;
      color: #00ff00;
      font-family: 'Share Tech Mono', monospace;
      font-size: 14px;
      padding: 10px 40px 10px 12px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      letter-spacing: 1px;
    }
    #keyInput:focus {
      border-color: #00ff00;
      box-shadow: 0 0 10px rgba(0,255,0,0.25);
    }
    #toggleKeyVis {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: rgba(0,255,0,0.5);
      font-size: 14px;
      user-select: none;
    }
    #loginBtn {
      width: 100%;
      background: linear-gradient(90deg, #005500, #00aa00);
      color: #fff;
      border: 1px solid #00ff00;
      border-radius: 8px;
      padding: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 2px;
      transition: 0.2s;
      box-shadow: 0 0 12px rgba(0,255,0,0.2);
    }
    #loginBtn:hover { filter: brightness(1.15); }
    #loginBtn:disabled { opacity: 0.55; cursor: not-allowed; }
    #loginStatus {
      margin-top: 14px;
      font-size: 12px;
      min-height: 18px;
      letter-spacing: 1px;
    }
    .status-loading { color: #ffff00; }
    .status-error   { color: #ff4444; }
    .status-ok      { color: #00ff00; }
    .login-footer {
      margin-top: 20px;
      font-size: 10px;
      color: rgba(0,255,0,0.25);
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <iframe id="fullscreenIframe" src="https://web.sunwin.pw/?affId=Sunwin" name="fullscreenIframe"></iframe>

  <!-- ===== LOGIN SCREEN ===== -->
  <div id="loginScreen">
    <div class="login-box">
      <img src="https://i.postimg.cc/QC0Lcx3F/B2D88ED8-8C0D-4296-ACC2-A039952593EC.png" alt="Logo" class="login-logo">
      <div class="login-title">‚ö° X√ÅC TH·ª∞C KEY ‚ö°</div>
      <div class="login-subtitle">Nh·∫≠p key ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng</div>
      <div class="key-input-wrap">
        <input type="password" id="keyInput" placeholder="Nh·∫≠p key c·ªßa b·∫°n..." autocomplete="off" spellcheck="false">
        <span id="toggleKeyVis" title="Hi·ªán/·∫©n key">üëÅ</span>
      </div>
      <button id="loginBtn">ƒêƒÇNG NH·∫¨P</button>
      <div id="loginStatus"></div>
      <div class="login-footer">POWERED BY AI MASTER SYSTEM</div>
    </div>
  </div>
  <div class="panel">
    <button id="activateBtn" class="btn" disabled style="display:none;">K√≠ch Ho·∫°t</button>

  </div>
  
  <div id="predictionPopup" class="prediction-box" role="dialog" aria-hidden="true">
    <div class="item">
        <span class="label">T√ÄI</span>
        <div id="taiCircle" class="circle tai"></div>
    </div>
    <img src="https://i.postimg.cc/QC0Lcx3F/B2D88ED8-8C0D-4296-ACC2-A039952593EC.png" alt="Logo" class="logo">
    <div class="item">
        <span class="label">X·ªàU</span>
        <div id="xiuCircle" class="circle xiu"></div>
    </div>
    <span class="close-btn">‚úñ</span>
  </div>

  <div class="footer-text">
    <div id="footerInfo" class="blinking-text">
      Phi√™n: --- | D·ª± ƒêo√°n: --- | ƒê·ªô Tin C·∫≠y: ---
    </div>
  </div>
  <script>
  /* ===== LOGIN / KEY VERIFICATION LOGIC ===== */
  (function() {
    const LOGIN_KEY = 'sw_auth_key';
    const LS_API = 'https://key-admin-sew.onrender.com';
    const loginScreen = document.getElementById('loginScreen');
    const keyInput    = document.getElementById('keyInput');
    const loginBtn    = document.getElementById('loginBtn');
    const loginStatus = document.getElementById('loginStatus');
    const toggleVis   = document.getElementById('toggleKeyVis');
    const activateBtn = document.getElementById('activateBtn');

    // T·∫°o Device ID
    function getDeviceId() {
      let id = localStorage.getItem('_sw_did');
      if (!id) {
        id = 'SW-' + Math.random().toString(36).slice(2, 6).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
        localStorage.setItem('_sw_did', id);
      }
      return id;
    }

    // L·∫•y t√™n device
    function getDeviceName() {
      const ua = navigator.userAgent;
      if (/iPhone/.test(ua)) return 'iPhone';
      if (/iPad/.test(ua)) return 'iPad';
      if (/Android/.test(ua)) return 'Android';
      if (/Windows/.test(ua)) return 'Windows PC';
      if (/Mac/.test(ua)) return 'MacOS';
      return 'Browser';
    }

    // Format ng√†y th√°ng
    function formatDate(d) {
      if (!d) return 'Vƒ©nh vi·ªÖn';
      return new Date(d).toLocaleDateString('vi-VN', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    // Format lo·∫°i key
    function formatType(t) {
      return { day: '1 Ng√†y', week: '1 Tu·∫ßn', month: '1 Th√°ng', lifetime: 'Vƒ©nh Vi·ªÖn' }[t] || t || '‚Äî';
    }

    // Kh√¥ng x√≥a session khi load - ƒë·ªÉ checkSession() c√≥ th·ªÉ ph·ª•c h·ªìi ƒëƒÉng nh·∫≠p
    console.log('[KEY-AUTH] App loaded, checking session...');

    // Hi·ªán/·∫©n key
    toggleVis.addEventListener('click', () => {
      keyInput.type = keyInput.type === 'password' ? 'text' : 'password';
    });

    loginBtn.addEventListener('click', () => {
      const key = keyInput.value.trim().toUpperCase();
      if (!key) {
        showStatus('‚ö† Vui l√≤ng nh·∫≠p key!', 'error');
        return;
      }
      verifyKey(key);
    });

    keyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });

    async function verifyKey(key) {
      loginBtn.disabled = true;
      showStatus('üîÑ ƒêang x√°c th·ª±c...', 'loading');

      try {
        const deviceId = getDeviceId();
        const deviceName = getDeviceName();

        console.log('[KEY-AUTH] Verifying with:', { key, deviceId, deviceName });

        const res = await fetch(LS_API + '/api/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: key, deviceId: deviceId, deviceName: deviceName })
        });

        const data = await res.json();
        console.log('[KEY-AUTH] Response:', data);

        if (!data.success) {
          showStatus('‚ùå ' + (data.message || 'Key kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n!'), 'error');
          loginBtn.disabled = false;
          return;
        }

        // X√°c th·ª±c th√†nh c√¥ng
        const user = data.user || {};
        showStatus('‚úÖ X√°c th·ª±c th√†nh c√¥ng!', 'ok');
        
        // L∆∞u session
        localStorage.setItem(LOGIN_KEY, JSON.stringify({
          key: key,
          deviceId: deviceId,
          verifiedAt: Date.now(),
          expiresAt: user.expiresAt,
          user: user
        }));

        // M·ªü giao di·ªán
        document.querySelector('.panel').classList.add('unlocked');
        document.querySelector('.footer-text').classList.add('unlocked');
        
        activateBtn.disabled = false;
        activateBtn.style.display = 'block';
        activateBtn.style.opacity = '1';
        activateBtn.style.cursor = 'pointer';

        setTimeout(() => {
          loginScreen.style.opacity = '0';
          loginScreen.style.transition = 'opacity 0.5s';
          setTimeout(() => loginScreen.style.display = 'none', 500);
        }, 700);

      } catch(e) {
        console.error('[KEY-AUTH] Error:', e.message);
        showStatus('‚ùå L·ªói k·∫øt n·ªëi: ' + e.message, 'error');
        loginBtn.disabled = false;
      }
    }

    // Ki·ªÉm tra session c≈©
    async function checkSession() {
      const saved = localStorage.getItem(LOGIN_KEY);
      if (!saved) return;

      try {
        const sess = JSON.parse(saved);
        // Check h·∫øt h·∫°n
        if (sess.expiresAt && Date.now() > new Date(sess.expiresAt).getTime()) {
          localStorage.removeItem(LOGIN_KEY);
          return;
        }

        const deviceId = getDeviceId();
        const deviceName = getDeviceName();

        // Verify session v·ªõi server
        const res = await fetch(LS_API + '/api/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: sess.key, deviceId: deviceId, deviceName: deviceName })
        });

        const data = await res.json();
        if (data.success) {
          // Session v·∫´n h·ª£p l·ªá, v√†o lu√¥n
          loginScreen.style.opacity = '0';
          loginScreen.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            loginScreen.style.display = 'none';
            document.querySelector('.panel').classList.add('unlocked');
            document.querySelector('.footer-text').classList.add('unlocked');
            activateBtn.disabled = false;
            activateBtn.style.display = 'block';
            activateBtn.style.opacity = '1';
            activateBtn.style.cursor = 'pointer';
          }, 500);
        } else {
          localStorage.removeItem(LOGIN_KEY);
        }
      } catch(e) {
        // N·∫øu m·∫•t k·∫øt n·ªëi nh∆∞ng session ch∆∞a h·∫øt h·∫°n, cho v√†o
        try {
          const sess = JSON.parse(localStorage.getItem(LOGIN_KEY));
          if (!sess.expiresAt || Date.now() < new Date(sess.expiresAt).getTime()) {
            loginScreen.style.opacity = '0';
            loginScreen.style.transition = 'opacity 0.5s';
            setTimeout(() => {
              loginScreen.style.display = 'none';
              document.querySelector('.panel').classList.add('unlocked');
              document.querySelector('.footer-text').classList.add('unlocked');
              activateBtn.disabled = false;
              activateBtn.style.display = 'block';
              activateBtn.style.opacity = '1';
              activateBtn.style.cursor = 'pointer';
            }, 500);
          }
        } catch(e2) {}
      }
    }

    function showStatus(msg, type) {
      loginStatus.textContent = msg;
      loginStatus.className = '';
      if (type === 'loading') loginStatus.classList.add('status-loading');
      if (type === 'error')   loginStatus.classList.add('status-error');
      if (type === 'ok')      loginStatus.classList.add('status-ok');
    }

    // Ki·ªÉm tra session khi load
    window.addEventListener('DOMContentLoaded', checkSession);
  })();
  </script>
  <script>
  const fullscreenIframe = document.getElementById('fullscreenIframe');

  const activateBtn = document.getElementById('activateBtn');
  const predictionPopup = document.getElementById('predictionPopup');
  const footerInfo = document.getElementById('footerInfo');
  
  const taiCircle = document.getElementById('taiCircle');
  const xiuCircle = document.getElementById('xiuCircle');
  const closePopup = predictionPopup.querySelector('.close-btn');

  /* --- State & Config --- */
  let fetchIntervalId = null;
  let blinkIntervalId = null; 
  let currentSessionId = null; // Bi·∫øn l∆∞u tr·ªØ phi√™n hi·ªán t·∫°i t·ª´ API
  let isAwaitingNewSession = false; // Bi·∫øn c·ªù ƒë·ªÉ ngƒÉn fetchPrediction() g·ªçi startPredictionBlink() trong th·ªùi gian ch·ªù 6 gi√¢y
  // ƒê√£ c·∫≠p nh·∫≠t URL API m·ªõi
  const API_URL = 'https://sunlaymaynkx.hacksieucap.pro/ttsunver2?t=1771672905088'; 

  /* --- API & Prediction Logic --- */

  // H√†m ƒë·ªãnh d·∫°ng k·∫øt qu·∫£ (vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu)
  function capitalize(s) {
    if (!s) return '---';
    // ƒê·∫£m b·∫£o ch·ªØ c√°i ƒë·∫ßu ƒë∆∞·ª£c vi·∫øt hoa, ph·∫ßn c√≤n l·∫°i vi·∫øt th∆∞·ªùng
    return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
  }

  /* --- CORE THU·∫¨T TO√ÅN VIP (LOCAL - PH√ÇN T√çCH CHUY√äN GIA) --- */
  
  // H√†m t·∫°o s·ªë ng·∫´u nhi√™n gi·∫£ l·∫≠p nh∆∞ng c·ªë ƒë·ªãnh theo phi√™n (Deterministic Random)
  function pseudoRandom(seed) {
      let x = Math.sin(seed) * 10000;
      return x - Math.floor(x);
  }

  // H√†m l·∫•y k·∫øt qu·∫£ gi·∫£ l·∫≠p c·ªßa m·ªôt phi√™n qu√° kh·ª© (ƒë·ªÉ x√¢y d·ª±ng l·ªãch s·ª≠ c·∫ßu)
  function getSimulatedResult(session) {
      // Quy ∆∞·ªõc: < 0.5 l√† X·ªâu (X), >= 0.5 l√† T√†i (T)
      return pseudoRandom(session) >= 0.5 ? 'T' : 'X';
  }

  // B·ªô ph√¢n t√≠ch c·∫ßu chuy√™n nghi·ªáp -> C·∫¨P NH·∫¨T: GI·∫¢ L·∫¨P HACK K·∫æT QU·∫¢ NH√Ä C√ÅI
  function analyzeAlgorithm(currentSession) {
      // S·ª≠ d·ª•ng thu·∫≠t to√°n Random c·ªë ƒë·ªãnh theo phi√™n ƒë·ªÉ gi·∫£ l·∫≠p vi·ªác "ƒë·ªçc" ƒë∆∞·ª£c k·∫øt qu·∫£ t·ª´ server
      // V√¨ pseudoRandom(session) lu√¥n tr·∫£ v·ªÅ c√πng 1 s·ªë v·ªõi c√πng 1 session, 
      // n√™n k·∫øt qu·∫£ s·∫Ω nh·∫•t qu√°n (gi·ªëng nh∆∞ ƒë√£ bi·∫øt tr∆∞·ªõc).
      
      let rand = pseudoRandom(currentSession);
      
      // Quy ∆∞·ªõc: < 0.5 l√† X·ªâu, >= 0.5 l√† T√†i (M√¥ ph·ªèng t·ª∑ l·ªá 50/50 c·ªßa nh√† c√°i)
      let prediction = rand >= 0.5 ? 'T' : 'X';
      
      // T·∫°o c√°c l√Ω do "Hack" nghe nguy hi·ªÉm v√† uy t√≠n
      // T·∫°o c√°c l√Ω do "AI Si√™u C·∫•p Pro" nghe chuy√™n nghi·ªáp
      const strategies = [
          "READ_MEMORY: 0x8F2A... (Success)",
          "INJECT_SQL: L·∫•y K·∫øt Qu·∫£ T∆∞∆°ng Lai",
          "SERVER_RESPONSE: G√≥i Tin ∆Øu Ti√™n",
          "BYPASS_MD5: Gi·∫£i M√£ Ho√†n T·∫•t",
          "ADMIN_TOOLS: Truy C·∫≠p C·ªïng Game",
          "BOT_TRADING: Ph√¢n T√≠ch D√≤ng Ti·ªÅn L·ªõn",
          "SUPER_AI: Ph√¢n T√≠ch ƒêa Chi·ªÅu (100%)",
          "BIG_DATA: Qu√©t 10 Tri·ªáu Phi√™n",
          "DEEP_MIND: M√¥ H√¨nh H·ªçc S√¢u",
          "EXPERT_BOT: Chuy√™n Gia Ph√¢n T√≠ch",
          "QUANTUM_COMPUTING: Gi·∫£i M√£ MD5",
          "GLOBAL_TREND: Xu H∆∞·ªõng D√≤ng Ti·ªÅn",
          "PATTERN_RECOGNITION: Kh·ªõp C·∫ßu 100%",
          "PREDICTIVE_MODEL: D·ª± B√°o T∆∞∆°ng Lai"
      ];
      
      // Ch·ªçn l√Ω do d·ª±a tr√™n phi√™n (ƒë·ªÉ c·ªë ƒë·ªãnh l√Ω do cho m·ªói phi√™n)
      let strategyIndex = Math.floor(pseudoRandom(currentSession + 999) * strategies.length);
      let strategyName = strategies[strategyIndex];
      
      // ƒê·ªô tin c·∫≠y c·ª±c cao (99% - 100%) cho ch·∫ø ƒë·ªô Si√™u C·∫•p Pro
      let confidence = 99 + Math.floor(pseudoRandom(currentSession + 777) * 2);

      return {
          prediction: prediction,
          confidence: confidence,
          strategy: strategyName
      };
  }

  // Danh s√°ch Proxy ƒë·ªÉ x·ª≠ l√Ω l·ªói k·∫øt n·ªëi (CORS)
  const PROXY_HANDLERS = [
    (url) => url, // K·∫øt n·ªëi tr·ª±c ti·∫øp
    (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, // Proxy CodeTabs (R·∫•t ·ªïn ƒë·ªãnh)
    (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  ];

  async function fetchPrediction() {
    let data = null;
    let lastError = null;
    const targetUrl = API_URL + `?t=${Date.now()}`; // URL g·ªëc k√®m timestamp

    // Th·ª≠ l·∫ßn l∆∞·ª£t qua c√°c Proxy
    for (const createProxyUrl of PROXY_HANDLERS) {
      try {
        const finalUrl = createProxyUrl(targetUrl);
        // Th√™m timeout 3s ƒë·ªÉ tr√°nh treo tool khi m·∫°ng lag
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        const response = await fetch(finalUrl, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        data = await response.json();
        if (data) break; // Th√†nh c√¥ng th√¨ tho√°t v√≤ng l·∫∑p
      } catch (error) {
        lastError = error;
        continue; // Th·ª≠ proxy ti·∫øp theo
      }
    }

    if (!data) {
      // N·∫øu kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API, t·ª± ƒë·ªông chuy·ªÉn sang ch·∫ø ƒë·ªô GI·∫¢ L·∫¨P (Offline)
      // Gi√∫p tool lu√¥n ho·∫°t ƒë·ªông ngay c·∫£ khi m·∫°ng l·ªói ho·∫∑c API ch·∫øt
      console.warn("API Error: Chuy·ªÉn sang ch·∫ø ƒë·ªô gi·∫£ l·∫≠p.");
      // T·∫°o phi√™n gi·∫£ l·∫≠p thay ƒë·ªïi m·ªói 60 gi√¢y (gi·ªëng server th·∫≠t)
      const fakeSession = 3000000 + Math.floor(Date.now() / 60000);
      data = {
          phien_hien_tai: fakeSession,
          // Kh√¥ng c√≥ tr∆∞·ªùng du_doan -> Tool s·∫Ω t·ª± d√πng thu·∫≠t to√°n ph√¢n t√≠ch n·ªôi b·ªô
      };
    }

    try {
      console.log("D·ªØ li·ªáu API:", data);

      // X·ª≠ l√Ω c·∫•u tr√∫c JSON m·ªõi
      let nextSessionId;

      if (data.phien_dudoan) {
          nextSessionId = data.phien_dudoan;
      } else if (data.phien) {
          nextSessionId = data.phien + 1;
      } else if (data.phien_hien_tai && typeof data.phien_hien_tai === 'object' && data.phien_hien_tai.phi√™n) {
          nextSessionId = data.phien_hien_tai.phi√™n;
      } else if (data.phi√™n_d·ª±_ƒëo√°n) {
          nextSessionId = data.phi√™n_d·ª±_ƒëo√°n;
      } else {
          nextSessionId = data.phien_hien_tai;
      }
      
      // Chuy·ªÉn ƒë·ªïi ID phi√™n sang s·ªë ƒë·ªÉ t√≠nh to√°n
      const numericSessionId = parseInt(String(nextSessionId).replace(/\D/g, '')) || 0;

      // --- LOGIC M·ªöI: D·ª∞ ƒêO√ÅN NH∆Ø ƒê√É BI·∫æT K·∫æT QU·∫¢ ---
      const analysis = analyzeAlgorithm(numericSessionId);
      let predictedResult, displayPrediction, displayConfidence, displayStrategy;

      // --- LOGIC C·∫¨P NH·∫¨T: ∆ØU TI√äN D·ªÆ LI·ªÜU TH·∫¨T T·ª™ API ---
      if (data.du_doan || data.prediction) {
          // L·∫•y d·ªØ li·ªáu th·ª±c t·∫ø t·ª´ API (N·∫øu API c√≥ tr·∫£ v·ªÅ k·∫øt qu·∫£)
          const predObj = data.du_doan || data.prediction;
          const isObject = typeof predObj === 'object' && predObj !== null;
          const rawResult = (isObject ? (predObj.ket_qua || predObj.result) : predObj) || '';
          
          predictedResult = String(rawResult).toLowerCase().includes('t√†i') || String(rawResult).toUpperCase() === 'T' ? 'T' : 'X';
          displayPrediction = predictedResult === 'T' ? 'T√†i' : 'X·ªâu';
          
          // S·ª≠a t·ªâ l·ªá theo t·ªâ l·ªá c·ªßa api
          const rawConfidence = (isObject ? (predObj.ti_le || predObj.do_tin_cay || predObj.win_rate || predObj.confidence) : (data.ti_le || data.do_tin_cay_ai || data.win_rate));
          displayConfidence = rawConfidence ? (String(rawConfidence).includes('%') ? rawConfidence : rawConfidence + '%') : '85%';
          
          if (data.loai_cau && data.loai_cau.mo_ta) {
              displayStrategy = `AI: ${data.loai_cau.mo_ta}`;
          } else if (isObject && predObj.chi_tiet) {
              displayStrategy = `AI: ${predObj.chi_tiet}`;
          } else {
              displayStrategy = "AI_MASTER: D·ªØ Li·ªáu ƒê√£ ƒê∆∞·ª£c Ki·ªÉm Duy·ªát";
          }
      } else if (data.thong_ke && data.pattern_recent_100) {
          // Logic t·ª± t√≠nh to√°n d·ª±a tr√™n th·ªëng k√™ API (N·∫øu API tr·∫£ v·ªÅ thong_ke nh∆∞ng kh√¥ng c√≥ du_doan)
          const lastResult = data.pattern_recent_100.slice(-1); // T ho·∫∑c X
          const stats = data.thong_ke.ty_le_chuyen_tiep || {};
          const parsePct = (val) => parseFloat(String(val).replace('%', '')) || 0;
          
          let probT = 0, probX = 0;
          if (lastResult === 'T') {
              probT = parsePct(stats['T->T'] || 0);
              probX = parsePct(stats['T->X'] || 0);
          } else {
              probT = parsePct(stats['X->T'] || 0);
              probX = parsePct(stats['X->X'] || 0);
          }
          
          predictedResult = probT > probX ? 'T' : 'X';
          displayConfidence = (probT > probX ? probT : probX) + '%';
          displayPrediction = predictedResult === 'T' ? 'T√†i' : 'X·ªâu';
          displayStrategy = `Th·ªëng K√™ API: ${lastResult} ‚ûî ${predictedResult}`;
      } else {
          // Fallback: D√πng thu·∫≠t to√°n gi·∫£ l·∫≠p n·∫øu API ch∆∞a c√≥ k·∫øt qu·∫£
          predictedResult = analysis.prediction;
          displayPrediction = predictedResult === 'T' ? 'T√†i' : 'X·ªâu';
          displayConfidence = analysis.confidence + '%';
          displayStrategy = analysis.strategy;
      }
      
      // C·∫≠p nh·∫≠t th√¥ng tin ·ªü g√≥c ph·∫£i d∆∞·ªõi c√πng
      // S·ª≠ d·ª•ng innerHTML ƒë·ªÉ hi·ªÉn th·ªã 2 d√≤ng (D√≤ng 2 l√† t√™n thu·∫≠t to√°n/hack)
      footerInfo.innerHTML = `Phi√™n: ${nextSessionId} | D·ª± ƒêo√°n: ${displayPrediction} (${displayConfidence})<br><span style="font-size:11px; color:#ffff00; text-shadow: none;">${displayStrategy}</span>`;

      // N·∫øu ƒëang trong th·ªùi gian ch·ªù 6 gi√¢y, kh√¥ng l√†m g√¨ c·∫£
      if (isAwaitingNewSession) {
          console.log(`ƒêang ch·ªù h·∫øt 6 gi√¢y cho phi√™n ${currentSessionId}. B·ªè qua nh√°y.`);
          return;
      }
      
      // X·ª≠ l√Ω logic nh√°y
      if (currentSessionId && currentSessionId !== nextSessionId) {
        // H·∫øt phi√™n (Phi√™n ƒë√£ thay ƒë·ªïi: 1 -> 2)
        console.log(`Phi√™n thay ƒë·ªïi: ${currentSessionId} -> ${nextSessionId}. B·∫Øt ƒë·∫ßu ng∆∞ng nh√°y 6 gi√¢y.`);
        stopBlink(); // D·ª´ng nh√°y c≈© ngay l·∫≠p t·ª©c
        isAwaitingNewSession = true; // B·∫≠t c·ªù ch·ªù
        currentSessionId = nextSessionId; // C·∫≠p nh·∫≠t phi√™n m·ªõi

        // B·∫Øt ƒë·∫ßu nh√°y sau 6 gi√¢y (ƒê√∫ng nh·ªãp y√™u c·∫ßu)
        setTimeout(() => {
          isAwaitingNewSession = false; // T·∫Øt c·ªù ch·ªù
          console.log(`H·∫øt 6 gi√¢y. B·∫Øt ƒë·∫ßu nh√°y cho phi√™n m·ªõi: ${currentSessionId}`);
          // G·ªçi l·∫°i startPredictionBlink v·ªõi d·ªØ li·ªáu d·ª± ƒëo√°n m·ªõi nh·∫•t
          // **Quan tr·ªçng:** C·∫ßn l·∫•y l·∫°i d·ªØ li·ªáu d·ª± ƒëo√°n m·ªõi nh·∫•t t·ª´ API ·ªü l·∫ßn fetch ti·∫øp theo (s·∫Ω x·∫£y ra sau 1 gi√¢y n·ªØa)
          // Hi·ªán t·∫°i, ch·ªâ c·∫ßn ƒë·∫£m b·∫£o logic ch·ªù 6 gi√¢y l√† ch√≠nh x√°c.
          // ƒê·ªÉ ƒë·∫£m b·∫£o nh√°y ƒë√∫ng d·ª± ƒëo√°n c·ªßa phi√™n m·ªõi, ta s·∫Ω g·ªçi l·∫°i fetchPrediction ngay khi h·∫øt th·ªùi gian ch·ªù 6 gi√¢y, 
          // thay v√¨ ch·ªâ g·ªçi startPredictionBlink v·ªõi d·ªØ li·ªáu c≈©.
          fetchPrediction(); // G·ªçi fetchPrediction ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t v√† b·∫Øt ƒë·∫ßu nh√°y
        }, 6000); 
      } else if (currentSessionId === null || currentSessionId === nextSessionId) {
          // L·∫ßn ƒë·∫ßu ch·∫°y HO·∫∂C v·∫´n trong c√πng phi√™n, B·∫Øt ƒë·∫ßu/Ti·∫øp t·ª•c nh√°y
          currentSessionId = nextSessionId; // ƒê·∫£m b·∫£o phi√™n ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t
          // B·∫Øt ƒë·∫ßu nh√°y (startPredictionBlink s·∫Ω d·ª´ng nh√°y c≈© tr∆∞·ªõc n·∫øu c·∫ßn)
          if (!blinkIntervalId) { 
             startPredictionBlink(predictedResult);
          }
      }

    } catch (error) {
      console.error("L·ªói x·ª≠ l√Ω d·ªØ li·ªáu:", error);
      footerInfo.textContent = `L·ªói d·ªØ li·ªáu: ${error.message}`;
      stopBlink();
    }
  }

  function startPredictionBlink(predictedResult) {
      // ƒê·∫£m b·∫£o d·ª´ng nh√°y c≈© tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu c√°i m·ªõi
      stopBlink(); 
      
      const targetCircle = (predictedResult === 'T') ? taiCircle : xiuCircle;
      const otherCircle = (predictedResult === 'T') ? xiuCircle : taiCircle;

      // ƒê·∫£m b·∫£o n√∫t c√≤n l·∫°i b·ªã t·∫Øt
      otherCircle.classList.remove("active"); 

      // B·∫Øt ƒë·∫ßu nh√°y
      let isBlinking = true;
      blinkIntervalId = setInterval(()=>{
          if(isBlinking){
              targetCircle.classList.add("active");
          } else {
              targetCircle.classList.remove("active");
          }
          isBlinking = !isBlinking;
      }, 500); // Nh√°y m·ªói 0.5 gi√¢y
  }

  function stopBlink(){
      if(blinkIntervalId){
          clearInterval(blinkIntervalId);
          blinkIntervalId = null;
          taiCircle.classList.remove("active");
          xiuCircle.classList.remove("active");
      }
  }

  activateBtn.addEventListener('click', () => {
    // Button is disabled when not yet authenticated - should not reach here, but guard anyway
    if (activateBtn.disabled) {
      return; // Kh√¥ng l√†m g√¨ khi ch∆∞a x√°c th·ª±c
    }

    if (activateBtn.textContent.trim() === 'AI ACTIVATED') {
      // ƒê√£ k√≠ch ho·∫°t r·ªìi, kh√¥ng cho k√≠ch ho·∫°t l·∫°i
      return;
    }

    predictionPopup.style.display = 'flex';
    activateBtn.disabled = true;
    activateBtn.textContent = 'AI ACTIVATED';

    // Reset tr·∫°ng th√°i khi k√≠ch ho·∫°t
    currentSessionId = null; 
    isAwaitingNewSession = false;
    stopBlink(); // D·ª´ng nh√°y c≈© (n·∫øu c√≥)

    // L·∫•y d·ª± ƒëo√°n ngay l·∫≠p t·ª©c
    fetchPrediction(); 
    // Thi·∫øt l·∫≠p chu k·ª≥ l·∫•y d·ª± ƒëo√°n m·ªói 1 gi√¢y (ƒë·ªÉ theo d√µi nh·ªãp phi√™n nhanh v√† ch√≠nh x√°c)
    fetchIntervalId = setInterval(fetchPrediction, 1000); 
  });

  function showActivateError(msg) {
    const status = document.createElement('div');
    status.textContent = msg;
    status.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#ff4444;padding:20px;border-radius:10px;z-index:99999;font-size:14px;border:1px solid #ff4444';
    document.body.appendChild(status);
    setTimeout(() => status.remove(), 2000);
  };

  closePopup.addEventListener('click', () => {
    predictionPopup.style.display = 'none';
    if (fetchIntervalId) {
      clearInterval(fetchIntervalId);
      fetchIntervalId = null;
    }
    activateBtn.disabled = false;
    activateBtn.style.display = 'block';
    activateBtn.textContent = 'K√≠ch Ho·∫°t';
    stopBlink(); 
    // Reset tr·∫°ng th√°i ƒë·ªÉ l·∫ßn k√≠ch ho·∫°t ti·∫øp theo ho·∫°t ƒë·ªông ƒë√∫ng
    currentSessionId = null;
    isAwaitingNewSession = false;
    footerInfo.textContent = 'Phi√™n: --- | D·ª± ƒêo√°n: --- | ƒê·ªô Tin C·∫≠y: ---'; // Reset info
  });

  /* === Logic K√©o th·∫£ (Gi·ªØ nguy√™n v√† ho·∫°t ƒë·ªông m∆∞·ª£t m√†) === */
  (function makeDraggable(el){
    let startX = 0, startY = 0;
    
    const dragStart = (e) => {
        if (e.target.classList.contains("close-btn")) return;
        e.preventDefault();
        
        // C·∫£i ti·∫øn: T√≠nh to√°n v·ªã tr√≠ ban ƒë·∫ßu c·ªßa ph·∫ßn t·ª≠ ƒë·ªÉ k√©o m∆∞·ª£t h∆°n
        const rect = el.getBoundingClientRect();
        
        // L·∫•y t·ªça ƒë·ªô con tr·ªè/ng√≥n tay
        let clientX = e.type.includes("touch") ? e.touches[0].clientX : e.clientX;
        let clientY = e.type.includes("touch") ? e.touches[0].clientY : e.clientY;
        
        // L∆∞u tr·ªØ ƒëi·ªÉm offset (kho·∫£ng c√°ch t·ª´ g√≥c tr√™n-tr√°i c·ªßa ph·∫ßn t·ª≠ ƒë·∫øn con tr·ªè)
        startX = clientX - rect.left;
        startY = clientY - rect.top;
        
        // ƒê·∫∑t v·ªã tr√≠ tuy·ªát ƒë·ªëi ban ƒë·∫ßu n·∫øu ch∆∞a c√≥
        if (el.style.position !== 'fixed' || el.style.transform !== "none") {
             el.style.left = rect.left + 'px';
             el.style.top = rect.top + 'px';
             el.style.position = 'fixed';
             el.style.right = "auto";
             el.style.bottom = "auto";
             el.style.transform = "none"; 
        }

        document.addEventListener("mousemove", dragging);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchmove", dragging, { passive: false });
        document.addEventListener("touchend", dragEnd);
    };

    const dragging = (e) => {
        let clientX = e.type.includes("touch") ? e.touches[0].clientX : e.clientX;
        let clientY = e.type.includes("touch") ? e.touches[0].clientY : e.clientY;
        
        // T√≠nh to√°n v·ªã tr√≠ m·ªõi
        let newX = clientX - startX;
        let newY = clientY - startY;

        // Gi·ªõi h·∫°n trong khung nh√¨n (tu·ª≥ ch·ªçn)
        const maxX = window.innerWidth - el.offsetWidth;
        const maxY = window.innerHeight - el.offsetHeight;
        
        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));
        
        el.style.left = newX + "px";
        el.style.top = newY + "px";
        e.preventDefault();
    };

    const dragEnd = () => {
        document.removeEventListener("mousemove", dragging);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchmove", dragging);
        document.removeEventListener("touchend", dragEnd);
    };

    el.addEventListener("mousedown", dragStart);
    el.addEventListener("touchstart", dragStart);
  })(predictionPopup);
  </script>
</body>
  </html>